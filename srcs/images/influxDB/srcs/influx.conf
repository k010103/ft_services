---
apiVersion: v1
kind: ConfigMap
metadata:
  name: influxdb-config
  labels:
    app: influxdb
data:
  influxdb.conf: |
    reporting-disabled = false
    bind-address = "127.0.0.1:8088"

		# 데이터를 저장할 위치 지정
    [meta]
      dir = "/var/lib/influxdb/meta" # 위치
      retention-autocreate = true # DB 생성 시 보존 정책의 자동 활성화
      logging-enabled = true # 메타 서비스의 메시지 로깅 사용

	# 데이터를 저장할 디렉토리 지정
    [data]
      dir = "/var/lib/influxdb/data"
      index-version = "tsi1" # 새 샤드에 사용할 샤드 인덱스 유형. 기본은 inmem
      wal-dir = "/var/lib/influxdb/wal" # 미리쓰기로그(wal) 파일의 디렉토리 위치
      wal-fsync-delay = "0s" # fsync 하기 전 대기시간. 0인 경우 wal에 쓸 때마다 수행
      query-log-enabled = false # 쿼리 로깅 활성화 여부
      cache-max-memory-size = 1073741824 # 샤드 캐시가 도달할 수 있는 최대 크리
      cache-snapshot-memory-size = 26214400 #
      cache-snapshot-write-cold-duration = "10m0s"
      compact-full-write-cold-duration = "4h0m0s"
      max-series-per-database = 1000000
      max-values-per-tag = 100000
      max-concurrent-compactions = 0
      trace-logging-enabled = false

	#Clustering 서비스 설정 통제
    [coordinator]
      write-timeout = "10s" # write-request가 기다릴 시간. 이 시간이 지나면 에러 리턴
      max-concurrent-queries = 0 # 최대 동시 쿼리 갯수, 0으로 할 경우 unlimited
      query-timeout = "0s" # 시스템 kill 전 쿼리 수행 허용 기간
      log-queries-after = "0s" # slow 쿼리를 기록할 한계. 0은 쿼리 로깅 X
      max-select-point = 0
      max-select-series = 0
      max-select-buckets = 0

	# 데이터 보관기간 설정
    [retention]
      enabled = true # 설정 사용 여부
      check-interval = "30m0s" # 명시된 시간에 한번씩 보관기간 정책 체크

    [shard-precreation]
      enabled = true # 샤드 사전 생성 여부
      check-interval = "10m0s" # 새 샤드 사전 생성 확인 실행
      advance-period = "30m0s" # 샤드를 미리 생성하는 최대 기간(최대 30분인 것)

	# 모니터링을 위한 내부 데이터베이스 생성 설정
    [monitor]
      store-enabled = true # 활성화 여부
      store-database = "_internal" # 저장할 DB이름
      store-interval = "10s" # 명시된 시간마다 통계치 저장

    [subscriber]
      enabled = true
      http-timeout = "30s"
      insecure-skip-verify = false
      ca-certs = ""
      write-concurrency = 40
      write-buffer-size = 1000

	# http 엔드포인트 설정
    [http]
      enabled = true
      bind-address = ":8086" # http에서 사용하는 바인드 주소
      auth-enabled = false # http로 할것인지 https로 할것인지 false면 http로 인증 요구 안하
      log-enabled = false # http요청 로깅 여부
      write-tracing = false # 로깅관련이지만 false
      pprof-enabled = true # 트러블 슈팅이나 모니터링에 사용
      https-enabled = false # https는 꺼줌
      https-certificate = "/etc/ssl/influxdb.pem" #https 인증서
      https-private-key = ""
      max-row-limit = 0
      max-connection-limit = 0 # 최대 연결 수 0은 무제한
      shared-secret = ""
      realm = "InfluxDB"
      unix-socket-enabled = false
      bind-socket = "/var/run/influxdb.sock"
      max-body-size = 25000000
      access-log-path = ""

    [logging]
      format = "auto"
      level = "info"
      suppress-logo = false

    [ifql]
      enabled = false
      log-enabled = true
      bind-address = ":8082"

    [[graphite]]
      enabled = false
      bind-address = ":2003"
      database = "graphite"
      retention-policy = ""
      protocol = "tcp"
      batch-size = 5000
      batch-pending = 10
      batch-timeout = "1s"
      consistency-level = "one"
      separator = "."
      udp-read-buffer = 0

    [[collectd]]
      enabled = false
      bind-address = ":25826"
      database = "collectd"
      retention-policy = ""
      batch-size = 5000
      batch-pending = 10
      batch-timeout = "10s"
      read-buffer = 0
      typesdb = "/usr/share/collectd/types.db"
      security-level = "none"
      auth-file = "/etc/collectd/auth_file"
      parse-multivalue-plugin = "split"

    [[opentsdb]]
      enabled = false
      bind-address = ":4242"
      database = "opentsdb"
      retention-policy = ""
      consistency-level = "one"
      tls-enabled = false
      certificate = "/etc/ssl/influxdb.pem"
      batch-size = 1000
      batch-pending = 5
      batch-timeout = "1s"
      log-point-errors = true

    [[udp]]
      enabled = false
      bind-address = ":8089"
      database = "udp"
      retention-policy = ""
      batch-size = 5000
      batch-pending = 10
      read-buffer = 0
      batch-timeout = "1s"
      precision = ""

    [continuous_queries]
      log-enabled = true
      enabled = true
      query-stats-enabled = false
      run-interval = "1s"
